name: ðŸ“Š RobÃ´ PNCP Ranking Turbo

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

concurrency:
  group: ranking-coleta-group
  cancel-in-progress: false

jobs:
  coleta:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    permissions:
      contents: write
      actions: write

    env:
      TZ: 'America/Sao_Paulo'

    steps:
      - name: ðŸ“¥ 1. Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ§¹ 2. Limpeza de EspaÃ§o em Disco
        # Este passo remove pacotes pesados prÃ©-instalados que vocÃª nÃ£o usa
        run: |
          echo "EspaÃ§o antes da limpeza:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          echo "EspaÃ§o apÃ³s a limpeza:"
          df -h

      - name: ðŸ 3. Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ 4. DependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install requests urllib3

      - name: ðŸ”„ 5. Executar Coleta
        run: |
          git pull origin main --rebase || echo "OK"
          python coleta_pncp.py

      - name: âš™ï¸ 6. Configurar Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ðŸ“¤ 7. Salvar Dados (ZIP)
        id: push-step
        run: |
          # Remove JSON se existir por engano para nÃ£o ocupar espaÃ§o no Git
          git rm --cached dados_pncp.json || echo "Limpo"
          
          # Adiciona ZIP e Checkpoint
          git add dados_pncp.zip checkpoint.txt
          
          TIMESTAMP=$(date '+%d/%m %H:%M')
          git commit -m "ðŸ“Š RANKING: Base Atualizada | $TIMESTAMP" || echo "Sem mudanÃ§as"
          
          git pull origin main --rebase
          if git push origin main; then
            echo "push_success=true" >> $GITHUB_OUTPUT
          else
            echo "push_success=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸš€ 8. Auto-ReinÃ­cio
        if: steps.push-step.outputs.push_success == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Verifica se o arquivo existe antes de ler para evitar erro de script
          if [ -f checkpoint.txt ]; then
            CHECKPOINT=$(cat checkpoint.txt)
            HOJE=$(date +'%Y%m%d')
            
            if [ "$CHECKPOINT" -lt "$HOJE" ]; then
              echo "Reiniciando para buscar prÃ³ximo dia..."
              sleep 10
              # Certifique-se que o nome do arquivo aqui Ã© o mesmo deste YAML (ex: main.yml)
              gh workflow run main.yml
            else
              echo "âœ… Tudo atualizado."
            fi
          else
            echo "Checkpoint nÃ£o encontrado."
          fi
