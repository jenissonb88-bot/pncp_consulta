name: ðŸ“Š RobÃ´ PNCP Ranking Turbo

on:
  schedule:
    - cron: '0 */2 * * *'  # Tenta iniciar a cada 2 horas (backup)
  workflow_dispatch:        # Permite iniciar manualmente

# LÃ³gica de ConcorrÃªncia: Coloca novas execuÃ§Ãµes na fila em vez de cancelar a atual
concurrency:
  group: ranking-coleta-group
  cancel-in-progress: false

jobs:
  coleta:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # Limite mÃ¡ximo de 6 horas do GitHub

    permissions:
      contents: write
      actions: write  # Permite que o robÃ´ dispare a si mesmo

    env:
      TZ: 'America/Sao_Paulo'

    steps:
      - name: ðŸ“¥ 1. Checkout do RepositÃ³rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ 2. Configurar Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ 3. Instalar DependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install requests urllib3

      - name: ðŸ”„ 4. Executar Coleta de Ranking
        run: |
          # Sincroniza antes de comeÃ§ar
          git pull origin main --rebase || echo "Sync inicial OK"
          python coleta_pncp.py

      - name: âš™ï¸ 5. Configurar Identidade Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ðŸ“¤ 6. Commit e Push (Apenas ZIP e Checkpoint)
        id: push-step
        run: |
          # Remove o JSON pesado do rastreamento do Git caso ele exista
          git rm --cached dados_pncp.json || echo "JSON jÃ¡ fora do rastreio"
          
          # Adiciona o ZIP compactado e o checkpoint
          git add dados_pncp.zip checkpoint.txt
          
          TIMESTAMP=$(date '+%d/%m %H:%M')
          git commit -m "ðŸ“Š RANKING: Dia Processado | $TIMESTAMP" || echo "Nada para commitar"
          
          # Tenta o push com rebase para evitar conflitos de sincronia
          git pull origin main --rebase
          if git push origin main; then
            echo "push_success=true" >> $GITHUB_OUTPUT
          else
            echo "push_success=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸš€ 7. Disparar PrÃ³xima Coleta (Auto-ReinÃ­cio)
        # SÃ³ dispara o prÃ³ximo se o push anterior deu certo
        if: steps.push-step.outputs.push_success == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CHECKPOINT=$(cat checkpoint.txt)
          HOJE=$(date +'%Y%m%d')
          
          if [ "$CHECKPOINT" -lt "$HOJE" ]; then
            echo "Ainda existem dias pendentes ($CHECKPOINT < $HOJE). Reiniciando agora..."
            sleep 10
            gh workflow run main.yml
          else
            echo "âœ… Base de dados do Ranking 100% atualizada!"
          fi
