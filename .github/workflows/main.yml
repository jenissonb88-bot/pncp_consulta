name: ðŸ“Š RobÃ´ PNCP Ranking Turbo

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

concurrency:
  group: ranking-coleta-group
  cancel-in-progress: false

jobs:
  coleta:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    permissions:
      contents: write
      actions: write

    env:
      TZ: 'America/Sao_Paulo'

    steps:
      - name: ðŸ“¥ 1. Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ 2. Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ 3. DependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install requests urllib3

      - name: ðŸ”„ 4. Executar Coleta
        run: |
          git pull origin main --rebase || echo "OK"
          python coleta_pncp.py

      - name: âš™ï¸ 5. Configurar Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ðŸ“¤ 6. Salvar Dados (ZIP)
        id: push-step
        run: |
          # Remove JSON se existir por engano
          git rm --cached dados_pncp.json || echo "Limpo"
          
          # Adiciona ZIP e Checkpoint
          git add dados_pncp.zip checkpoint.txt
          
          TIMESTAMP=$(date '+%d/%m %H:%M')
          git commit -m "ðŸ“Š RANKING: Base Atualizada | $TIMESTAMP" || echo "Sem mudanÃ§as"
          
          git pull origin main --rebase
          if git push origin main; then
            echo "push_success=true" >> $GITHUB_OUTPUT
          else
            echo "push_success=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸš€ 7. Auto-ReinÃ­cio
        if: steps.push-step.outputs.push_success == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CHECKPOINT=$(cat checkpoint.txt)
          HOJE=$(date +'%Y%m%d')
          
          if [ "$CHECKPOINT" -lt "$HOJE" ]; then
            echo "Reiniciando para buscar prÃ³ximo dia..."
            sleep 10
            gh workflow run main.yml
          else
            echo "âœ… Tudo atualizado."
          fi
