<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>PNCP Monitor - Pregão Eletrônico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --primary: #1e40af;
      --primary-dark: #1e3a8a;
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #1e293b;
      --border: #e2e8f0;
      --danger: #dc2626;
      --success: #059669;
      --warning: #d97706;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    header {
      background: var(--primary);
      color: #fff;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    header h1 {
      margin: 0 0 4px 0;
      font-size: 1.5rem;
    }

    header p {
      margin: 0;
      font-size: 0.95rem;
      opacity: 0.9;
    }

    #status {
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.9rem;
      margin: 12px 0;
    }

    .status-loading { background: #fef3c7; color: #92400e; }
    .status-success { background: #d1fae5; color: #065f46; }
    .status-error   { background: #fee2e2; color: #991b1b; }

    .controls {
      background: var(--card);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
    }

    .controls-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .controls label {
      font-size: 0.85rem;
      color: #475569;
    }

    .controls input,
    .controls select {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid var(--border);
      font-size: 0.9rem;
    }

    .controls button {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: #e2e8f0;
      color: #111827;
    }

    .table-wrapper {
      background: var(--card);
      border-radius: 8px;
      border: 1px solid var(--border);
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th, td {
      border-bottom: 1px solid var(--border);
      padding: 6px 8px;
      text-align: left;
      vertical-align: top;
    }

    th {
      background: #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tr:nth-child(even) td {
      background: #f9fafb;
    }

    a {
      color: var(--primary);
      text-decoration: none;
    }

    a:hover { text-decoration: underline; }

    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.75rem;
      margin-left: 4px;
    }

    .tag-ok { background: #dcfce7; color: var(--success); }
    .tag-warn { background: #fef3c7; color: var(--warning); }
    .tag-bad { background: #fee2e2; color: var(--danger); }

    .pagination {
      margin: 8px 0;
      font-size: 0.85rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .pagination button {
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid var(--border);
      font-size: 0.8rem;
      background: #fff;
      cursor: pointer;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    /* Modal simples */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 50;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: #fff;
      max-width: 900px;
      width: 95%;
      max-height: 80vh;
      border-radius: 8px;
      overflow: auto;
      border: 1px solid var(--border);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      background: #f1f5f9;
    }

    .modal-header h2 {
      font-size: 1rem;
      margin: 0;
    }

    .modal-close {
      border: none;
      background: none;
      font-size: 1.2rem;
      cursor: pointer;
    }

    .modal-body {
      padding: 8px 12px 12px 12px;
    }

    @media (max-width: 768px) {
      th, td {
        padding: 4px 6px;
      }
      header h1 {
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>PNCP Monitor</h1>
      <p>Pregão Eletrônico (código 6) – visão leve com filtros para busca.</p>
    </header>

    <div id="status" class="status-loading">
      Carregando dados do PNCP...
    </div>

    <div class="controls">
      <div class="controls-group">
        <label for="busca">Busca geral:</label>
        <input id="busca" type="text" placeholder="Órgão, objeto ou fornecedor">
      </div>

      <div class="controls-group">
        <label for="filtro-uf">UF:</label>
        <select id="filtro-uf">
          <option value="">Todas</option>
        </select>
      </div>

      <div class="controls-group">
        <label for="filtro-situacao">Situação (seu CNPJ):</label>
        <select id="filtro-situacao">
          <option value="">Todas</option>
          <option value="Venceu">Venceu</option>
          <option value="SemResultado">Sem resultado</option>
        </select>
      </div>

      <div class="controls-group">
        <button class="btn-secondary" id="btn-limpar">Limpar filtros</button>
        <button class="btn-primary" id="btn-aplicar">Aplicar filtros</button>
      </div>
    </div>

    <div class="pagination">
      <div>
        <span id="info-resultado">0 licitações</span>
      </div>
      <div>
        <button id="prev-page">&laquo; Anterior</button>
        <span id="page-info">Página 1</span>
        <button id="next-page">Próxima &raquo;</button>
      </div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Órgão/UASG</th>
            <th>Pregão / ID PNCP</th>
            <th>Período</th>
            <th>Cidade/UF</th>
            <th>Objeto</th>
            <th>Itens (seu CNPJ)</th>
          </tr>
        </thead>
        <tbody id="corpo-tabela"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal de itens -->
  <div id="modal-itens" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-titulo">Itens</h2>
        <button class="modal-close" id="modal-fechar">&times;</button>
      </div>
      <div class="modal-body">
        <table>
          <thead>
            <tr>
              <th>Item</th>
              <th>Descrição</th>
              <th>Data Homolog.</th>
              <th>Qtd</th>
              <th>Unitário</th>
              <th>Total</th>
              <th>Fornecedor</th>
              <th>Situação</th>
            </tr>
          </thead>
          <tbody id="modal-corpo"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const ITENS_POR_PAGINA = 20;
    let dadosCompletos = [];
    let dadosFiltrados = [];
    let paginaAtual = 1;

    async function carregarDadosPncp() {
      const status = document.getElementById('status');
      status.textContent = 'Carregando dados do PNCP...';
      status.className = 'status-loading';

      try {
        const resp = await fetch('dados_pncp.json?t=' + Date.now(), { cache: 'no-store' });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        dadosCompletos = await resp.json();
        dadosFiltrados = dadosCompletos.slice();
        preencherFiltroUF();
        paginaAtual = 1;
        atualizarTabela();
        status.textContent = 'Dados carregados com sucesso.';
        status.className = 'status-success';
      } catch (e) {
        status.textContent = 'Erro ao carregar dados: ' + e.message;
        status.className = 'status-error';
      }
    }

    function preencherFiltroUF() {
      const selectUF = document.getElementById('filtro-uf');
      const ufs = new Set();
      dadosCompletos.forEach(lic => {
        if (lic.uf) ufs.add(lic.uf);
      });
      const ordenadas = Array.from(ufs).sort();
      selectUF.innerHTML = '<option value=\"\">Todas</option>';
      ordenadas.forEach(uf => {
        const opt = document.createElement('option');
        opt.value = uf;
        opt.textContent = uf;
        selectUF.appendChild(opt);
      });
    }

    function aplicarFiltros() {
      const termo = document.getElementById('busca').value.toLowerCase().trim();
      const uf = document.getElementById('filtro-uf').value;
      const situacao = document.getElementById('filtro-situacao').value;

      dadosFiltrados = dadosCompletos.filter(lic => {
        let ok = true;

        if (termo) {
          const texto = [
            lic.orgao_nome,
            lic.numero_pregao,
            lic.objeto,
            lic.cidade,
            lic.id_pncp,
            ...(lic.itens || []).map(i => i.descricao),
            ...(lic.itens || []).map(i => i.fornecedor)
          ].join(' ').toLowerCase();
          if (!texto.includes(termo)) ok = false;
        }

        if (uf && lic.uf !== uf) ok = false;

        if (situacao) {
          if (!lic.itens || !lic.itens.some(i => i.situacao === situacao)) ok = false;
        }

        return ok;
      });

      paginaAtual = 1;
      atualizarTabela();
    }

    function atualizarTabela() {
      const corpo = document.getElementById('corpo-tabela');
      corpo.innerHTML = '';

      const total = dadosFiltrados.length;
      const inicio = (paginaAtual - 1) * ITENS_POR_PAGINA;
      const fim = Math.min(inicio + ITENS_POR_PAGINA, total);
      const paginaDados = dadosFiltrados.slice(inicio, fim);

      paginaDados.forEach((lic, indexLocal) => {
        const idxGlobal = inicio + indexLocal;
        const tr = document.createElement('tr');

        const orgaoUasg = `${lic.orgao_codigo || ''}/${lic.uasg || ''}`;
        const periodo = `${formatarData(lic.data_inicio_propostas)} a ${formatarData(lic.data_fim_propostas)}`;
        const cidadeUf = `${lic.cidade || ''}/${lic.uf || ''}`;
        const qtdItens = lic.itens ? lic.itens.length : 0;

        tr.innerHTML = `
          <td>${orgaoUasg}<br><small>${lic.orgao_nome || ''}</small></td>
          <td>
            ${lic.numero_pregao || ''}<br>
            <a href="${lic.link_edital || '#'}" target="_blank">${lic.id_pncp || ''}</a>
          </td>
          <td>${periodo}</td>
          <td>${cidadeUf}</td>
          <td>${(lic.objeto || '').substring(0, 80)}${lic.objeto && lic.objeto.length > 80 ? '...' : ''}</td>
          <td>
            ${qtdItens} item${qtdItens !== 1 ? 's' : ''}<br>
            <button type="button" data-idx="${idxGlobal}" class="btn-secondary btn-itens">
              Ver itens
            </button>
          </td>
        `;
        corpo.appendChild(tr);
      });

      document.getElementById('info-resultado').textContent =
        `${total} licitação${total !== 1 ? 'es' : ''} (mostrando ${inicio + 1}-${fim})`;

      const totalPaginas = Math.max(1, Math.ceil(total / ITENS_POR_PAGINA));
      document.getElementById('page-info').textContent = `Página ${paginaAtual} de ${totalPaginas}`;
      document.getElementById('prev-page').disabled = paginaAtual <= 1;
      document.getElementById('next-page').disabled = paginaAtual >= totalPaginas;

      document.querySelectorAll('.btn-itens').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.getAttribute('data-idx'), 10);
          abrirModalItens(idx);
        });
      });
    }

    function abrirModalItens(idxGlobal) {
      const lic = dadosFiltrados[idxGlobal];
      if (!lic || !lic.itens) return;

      document.getElementById('modal-titulo').textContent =
        `Itens – ${lic.numero_pregao || ''} – ${lic.orgao_nome || ''}`;

      const corpo = document.getElementById('modal-corpo');
      corpo.innerHTML = '';

      lic.itens.forEach(item => {
        const tr = document.createElement('tr');

        let tagHtml = '';
        if (item.situacao === 'Venceu') {
          tagHtml = '<span class="tag tag-ok">Venceu</span>';
        } else if (item.situacao === 'SemResultado') {
          tagHtml = '<span class="tag tag-bad">Sem resultado</span>';
        } else {
          tagHtml = `<span class="tag tag-warn">${item.situacao || ''}</span>`;
        }

        tr.innerHTML = `
          <td>${item.numero_item || ''}</td>
          <td>${item.descricao || ''}</td>
          <td>${formatarData(item.data_homologacao)}</td>
          <td>${item.quantidade || ''}</td>
          <td>${formatarMoeda(item.valor_unitario)}</td>
          <td>${formatarMoeda(item.valor_total_item)}</td>
          <td>${item.fornecedor || ''}</td>
          <td>${tagHtml}</td>
        `;
        corpo.appendChild(tr);
      });

      const modal = document.getElementById('modal-itens');
      modal.style.display = 'flex';
    }

    function fecharModal() {
      document.getElementById('modal-itens').style.display = 'none';
    }

    function formatarData(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(d)) return '';
      return d.toLocaleDateString('pt-BR');
    }

    function formatarMoeda(v) {
      if (v === null || v === undefined) return '';
      const n = Number(v);
      if (isNaN(n)) return '';
      return n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    document.getElementById('btn-aplicar').addEventListener('click', aplicarFiltros);
    document.getElementById('btn-limpar').addEventListener('click', () => {
      document.getElementById('busca').value = '';
      document.getElementById('filtro-uf').value = '';
      document.getElementById('filtro-situacao').value = '';
      dadosFiltrados = dadosCompletos.slice();
      paginaAtual = 1;
      atualizarTabela();
    });

    document.getElementById('prev-page').addEventListener('click', () => {
      if (paginaAtual > 1) {
        paginaAtual--;
        atualizarTabela();
      }
    });

    document.getElementById('next-page').addEventListener('click', () => {
      const total = dadosFiltrados.length;
      const totalPaginas = Math.max(1, Math.ceil(total / ITENS_POR_PAGINA));
      if (paginaAtual < totalPaginas) {
        paginaAtual++;
        atualizarTabela();
      }
    });

    document.getElementById('modal-fechar').addEventListener('click', fecharModal);
    document.getElementById('modal-itens').addEventListener('click', (e) => {
      if (e.target.id === 'modal-itens') fecharModal();
    });

    document.addEventListener('DOMContentLoaded', carregarDadosPncp);
  </script>
</body>
</html>
