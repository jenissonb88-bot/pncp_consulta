<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Ranking PNCP - Diagn√≥stico</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 p-4 font-sans">

    <div class="max-w-7xl mx-auto">
        <header class="bg-white p-6 rounded-lg shadow-sm mb-6 border border-slate-200">
            <h1 class="text-2xl font-black text-slate-800">üìä Painel de Diagn√≥stico</h1>
            <p class="text-sm text-slate-500">Se travar, leia o log abaixo.</p>
        </header>

        <div class="bg-slate-900 text-green-400 p-6 rounded-xl font-mono text-xs mb-6 shadow-lg overflow-y-auto max-h-60" id="console-log">
            > Iniciando sistema...<br>
        </div>

        <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-slate-200">
            <table class="min-w-full">
                <thead class="bg-slate-800 text-white text-[10px] uppercase font-bold">
                    <tr>
                        <th class="px-6 py-4 text-left">Resumo do Edital</th>
                        <th class="px-6 py-4 text-right">Valor</th>
                    </tr>
                </thead>
                <tbody id="corpo"></tbody>
            </table>
        </div>
    </div>

    <script>
        // Fun√ß√£o para escrever na caixa preta
        function log(msg, tipo="info") {
            const painel = document.getElementById('console-log');
            const cor = tipo === "erro" ? "text-red-400 font-bold bg-red-900/30 p-1" : "text-green-400";
            const icone = tipo === "erro" ? "‚ùå" : "‚úÖ";
            painel.innerHTML += `<div class="${cor} border-b border-slate-800 py-1">${icone} ${msg}</div>`;
            painel.scrollTop = painel.scrollHeight;
            console.log(msg);
        }

        async function init() {
            try {
                // Passo 1: Verificar JSZip
                if (typeof JSZip === 'undefined') {
                    throw new Error("A biblioteca JSZip n√£o carregou. Verifique sua conex√£o.");
                }
                log("Biblioteca JSZip carregada com sucesso.");

                // Passo 2: Tentar baixar o arquivo
                const url = 'dados_pncp.zip?v=' + Date.now();
                log(`Tentando baixar arquivo de: ${url}... aguarde.`);
                
                const response = await fetch(url);
                
                log(`Resposta do Servidor: Status ${response.status} (${response.statusText})`);

                if (!response.ok) {
                    throw new Error(`Erro Fatal: O GitHub respondeu com erro ${response.status}. O arquivo n√£o existe ou o link est√° errado.`);
                }

                // Passo 3: Converter para Blob
                const blob = await response.blob();
                log(`Arquivo baixado! Tamanho: ${(blob.size / 1024).toFixed(2)} KB.`);

                if (blob.size < 100) {
                    throw new Error("O arquivo ZIP est√° vazio (quase 0 KB). O rob√¥ falhou ao criar o arquivo.");
                }

                // Passo 4: Abrir o ZIP
                log("Tentando abrir o pacote ZIP...");
                const zip = await JSZip.loadAsync(blob);
                
                // Listar arquivos dentro do ZIP
                const arquivos = Object.keys(zip.files);
                log(`Arquivos encontrados dentro do ZIP: [ ${arquivos.join(', ')} ]`);

                // Passo 5: Achar o JSON
                const jsonFileName = arquivos.find(nome => nome.toLowerCase().endsWith('.json'));
                
                if (!jsonFileName) {
                    throw new Error("Nenhum arquivo .json encontrado dentro do pacote ZIP.");
                }
                log(`Arquivo alvo identificado: ${jsonFileName}`);

                // Passo 6: Ler o JSON
                log("Extraindo texto do JSON...");
                let texto = await zip.file(jsonFileName).async("string");
                log(`Texto extra√≠do! Comprimento: ${texto.length} caracteres.`);

                // Passo 7: Converter para Objeto
                // Limpeza bruta para evitar erros de caracteres estranhos
                texto = texto.replace(/[^\x20-\x7E\xA0-\xFF\n\r\t]/g, ""); 
                
                const db = JSON.parse(texto);
                log(`Sucesso! ${db.length} licita√ß√µes carregadas.`);

                render(db);

            } catch (erro) {
                log(erro.message, "erro");
                alert("ERRO: " + erro.message);
            }
        }

        function render(dados) {
            const corpo = document.getElementById('corpo');
            let html = "";
            dados.slice(0, 50).forEach(d => {
                html += `
                    <tr class="border-b hover:bg-slate-50">
                        <td class="px-6 py-4">
                            <div class="font-bold text-blue-600 text-xs">${d.edital}</div>
                            <div class="text-[10px] text-slate-500 uppercase">${d.orgao}</div>
                        </td>
                        <td class="px-6 py-4 text-right font-bold text-slate-700 text-xs">
                            R$ ${(d.total_licitacao || 0).toLocaleString('pt-br')}
                        </td>
                    </tr>
                `;
            });
            corpo.innerHTML = html;
            log("Tabela desenhada na tela.");
        }

        // Iniciar
        init();
    </script>
</body>
</html>
