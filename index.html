<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard PNCP - Licita√ß√µes P√∫blicas</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px 0;
        }

        .container-custom {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #333;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .header h1 i {
            color: #667eea;
        }

        .header p {
            color: #666;
            margin: 0;
            font-size: 0.95rem;
        }

        /* Alert */
        .alert {
            border-radius: 8px;
            border: none;
            padding: 15px 20px;
            margin-bottom: 20px;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Cards de Estat√≠sticas */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 5px solid #667eea;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .stat-card.valor {
            border-left-color: #28a745;
        }

        .stat-card.itens {
            border-left-color: #ffc107;
        }

        .stat-card.municipios {
            border-left-color: #17a2b8;
        }

        .stat-card.licitacoes {
            border-left-color: #667eea;
        }

        .stat-card h3 {
            color: #999;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-card .value {
            color: #333;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-card .subtitle {
            color: #999;
            font-size: 0.8rem;
        }

        /* Se√ß√£o de Filtros */
        .filters-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .filters-section h4 {
            color: #333;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filters-section h4 i {
            color: #667eea;
            font-size: 1.2rem;
        }

        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-select,
        .form-control {
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background-color: white;
            color: #333;
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-select:focus,
        .form-control:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-select {
            cursor: pointer;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
            color: white;
            text-decoration: none;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            color: white;
            text-decoration: none;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .btn-outline-primary {
            border: 2px solid #667eea;
            color: #667eea;
            background: white;
        }

        .btn-outline-primary:hover {
            background: #667eea;
            color: white;
            text-decoration: none;
        }

        /* Tabela */
        .table-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .table-container h4 {
            color: #333;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-container h4 i {
            color: #667eea;
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            color: #333;
            font-weight: 700;
            padding: 15px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table tbody td {
            padding: 15px;
            vertical-align: middle;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9rem;
        }

        .table tbody tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge.bg-success {
            background: #28a745 !important;
        }

        .badge.bg-info {
            background: #17a2b8 !important;
        }

        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            color: #667eea;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .text-muted {
            color: #999;
            font-size: 0.85rem;
        }

        /* Modal de Detalhes */
        .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom: none;
            border-radius: 12px 12px 0 0;
        }

        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }

        .modal-body {
            padding: 25px;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .detail-row.full {
            grid-template-columns: 1fr;
        }

        .detail-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .detail-label {
            color: #999;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
            display: block;
        }

        .detail-value {
            color: #333;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .table-modal {
            margin-top: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .table-modal thead {
            background: #f8f9fa;
        }

        .table-modal thead th {
            padding: 12px;
            font-size: 0.8rem;
            font-weight: 700;
            border-bottom: 2px solid #e0e0e0;
        }

        .table-modal tbody td {
            padding: 10px 12px;
            font-size: 0.8rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .table-modal tbody tr:last-child td {
            border-bottom: none;
        }

        /* Mensagem vazia */
        .empty-message {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-message i {
            font-size: 3rem;
            opacity: 0.3;
            margin-bottom: 15px;
            display: block;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .stats-cards {
                grid-template-columns: 1fr 1fr;
            }

            .detail-row {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .table-container {
                padding: 15px;
            }

            .table thead th,
            .table tbody td {
                padding: 10px;
                font-size: 0.8rem;
            }
        }

        /* Loading spinner */
        .spinner-border {
            width: 2rem;
            height: 2rem;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .loading-overlay.show {
            visibility: visible;
            opacity: 1;
        }

        .api-config {
            background: #e7f3ff;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .api-config strong {
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
    </div>

    <div class="container-custom">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-gavel"></i> Dashboard PNCP</h1>
            <p>An√°lise de Licita√ß√µes P√∫blicas em Tempo Real</p>
        </div>

        <!-- Alert de Configura√ß√£o -->
        <div id="alertas-container"></div>

        <!-- Cards de Estat√≠sticas -->
        <div class="stats-cards">
            <div class="stat-card licitacoes">
                <h3><i class="fas fa-file-contract"></i> Licita√ß√µes</h3>
                <div class="value" id="total-lic">-</div>
                <div class="subtitle">Total de processos</div>
            </div>
            <div class="stat-card valor">
                <h3><i class="fas fa-money-bill-wave"></i> Valor Total</h3>
                <div class="value" id="total-val">-</div>
                <div class="subtitle">Valor agregado</div>
            </div>
            <div class="stat-card itens">
                <h3><i class="fas fa-cubes"></i> Itens</h3>
                <div class="value" id="total-itens">-</div>
                <div class="subtitle">Total de itens</div>
            </div>
            <div class="stat-card municipios">
                <h3><i class="fas fa-map-marker-alt"></i> Munic√≠pios</h3>
                <div class="value" id="total-mun">-</div>
                <div class="subtitle">Cidades atendidas</div>
            </div>
        </div>

        <!-- Se√ß√£o de Filtros -->
        <div class="filters-section">
            <h4><i class="fas fa-filter"></i> Filtros Avan√ßados</h4>
            
            <div class="row g-3">
                <div class="col-lg-3 col-md-6">
                    <label class="form-label"><i class="fas fa-sitemap"></i> √ìrg√£o</label>
                    <select id="filtro-orgao" class="form-select">
                        <option value="">Todos os √ìrg√£os</option>
                    </select>
                </div>

                <div class="col-lg-2 col-md-6">
                    <label class="form-label"><i class="fas fa-map-pin"></i> Estado (UF)</label>
                    <select id="filtro-uf" class="form-select">
                        <option value="">Todos os Estados</option>
                    </select>
                </div>

                <div class="col-lg-2 col-md-6">
                    <label class="form-label"><i class="fas fa-building"></i> UASG</label>
                    <select id="filtro-uasg" class="form-select">
                        <option value="">Todos os UASG</option>
                    </select>
                </div>

                <div class="col-lg-3 col-md-6">
                    <label class="form-label"><i class="fas fa-industry"></i> Fornecedor</label>
                    <select id="filtro-fornecedor" class="form-select">
                        <option value="">Todos os Fornecedores</option>
                    </select>
                </div>

                <div class="col-lg-2 col-md-6">
                    <label class="form-label"><i class="fas fa-barcode"></i> N¬∫ Preg√£o</label>
                    <input type="text" id="filtro-pregao" class="form-control" 
                           placeholder="Ex: 20250101-0001">
                </div>
            </div>

            <div class="button-group">
                <button id="btn-filtrar" class="btn btn-primary">
                    <i class="fas fa-search"></i> Aplicar Filtros
                </button>
                <button id="btn-limpar-filtros" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Limpar Filtros
                </button>
            </div>
        </div>

        <!-- Tabela -->
        <div class="table-container">
            <h4><i class="fas fa-table"></i> Licita√ß√µes P√∫blicas</h4>
            
            <div class="table-responsive">
                <table id="tabela-licitacoes" class="table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>√ìrg√£o / Localiza√ß√£o</th>
                            <th>N¬∫ Preg√£o / ID PNCP</th>
                            <th>Data In√≠cio</th>
                            <th>Data Fim</th>
                            <th>Fornecedor</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="corpo-tabela">
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                <i class="fas fa-spinner fa-spin fa-2x mb-2 d-block"></i>
                                Carregando dados...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes -->
    <div class="modal fade" id="detalhesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-search-plus"></i> Detalhes da Licita√ß√£o</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Conte√∫do din√¢mico -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        // ==================== CONFIGURA√á√ÉO DA API ====================
        const CONFIG = {
            // Altere para sua URL real
            API_URL: 'https://api.pncp.gov.br/v1/licitacoes', // ALTERE AQUI!
            USE_MOCK_DATA: true, // true = dados de teste | false = API real
            TIMEOUT: 10000, // 10 segundos
            RETRIES: 3
        };

        let dataTable = null;
        let dadosOriginais = [];
        let tentativaAtual = 0;

        // ==================== FUN√á√ïES DE DADOS ====================

        function mostrarLoading(mostrar = true) {
            const overlay = document.getElementById('loadingOverlay');
            if (mostrar) {
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }
        }

        function exibirAlerta(tipo, titulo, mensagem) {
            const container = document.getElementById('alertas-container');
            const alertId = 'alert-' + Date.now();
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                    <strong>${titulo}:</strong> ${mensagem}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-remover em 5 segundos
            setTimeout(() => {
                const elem = document.getElementById(alertId);
                if (elem) elem.remove();
            }, 5000);
        }

        function formatarData(data) {
            if (!data) return 'N/D';
            try {
                const d = new Date(data);
                return d.toLocaleDateString('pt-BR');
            } catch {
                return data;
            }
        }

        function formatarMoeda(valor) {
            if (!valor) return 'R$ 0,00';
            return parseFloat(valor).toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
        }

        // ==================== CARREGAMENTO DOS DADOS ====================

        // Dados de teste (mock)
        function obterDadosMock() {
            return [
                {
                    'id_pncp': '08778201000126',
                    'numero_pregao': '20250101-0001',
                    'orgao_codigo': '26296',
                    'orgao_nome': 'Universidade Federal de Pernambuco',
                    'uasg': '150000',
                    'objeto': 'Fornecimento de medicamentos',
                    'cidade': 'Recife',
                    'uf': 'PE',
                    'data_inicio_propostas': '2025-01-01',
                    'data_fim_propostas': '2025-01-03',
                    'data_homologacao': '2025-01-05',
                    'fornecedor': 'Farmac√™utica XYZ',
                    'cnpj_fornecedor': '12.345.678/0001-90',
                    'itens': [
                        {
                            'numero_item': '001',
                            'descricao': 'Paracetamol 500mg',
                            'quantidade': 100,
                            'valor_unitario': 1.50,
                            'valor_total_item': 150.00
                        }
                    ]
                },
                {
                    'id_pncp': '08778201000127',
                    'numero_pregao': '20250102-0002',
                    'orgao_codigo': '26297',
                    'orgao_nome': 'Secretaria de Educa√ß√£o',
                    'uasg': '150001',
                    'objeto': 'Material de escrit√≥rio',
                    'cidade': 'Recife',
                    'uf': 'PE',
                    'data_inicio_propostas': '2025-01-02',
                    'data_fim_propostas': '2025-01-05',
                    'data_homologacao': '2025-01-06',
                    'fornecedor': 'Com√©rcio ABC LTDA',
                    'cnpj_fornecedor': '23.456.789/0001-01',
                    'itens': [
                        {
                            'numero_item': '001',
                            'descricao': 'Papel A4 (resma)',
                            'quantidade': 50,
                            'valor_unitario': 25.00,
                            'valor_total_item': 1250.00
                        },
                        {
                            'numero_item': '002',
                            'descricao': 'Canetas azuis',
                            'quantidade': 500,
                            'valor_unitario': 0.50,
                            'valor_total_item': 250.00
                        }
                    ]
                },
                {
                    'id_pncp': '08778201000128',
                    'numero_pregao': '20250103-0003',
                    'orgao_codigo': '26298',
                    'orgao_nome': 'Prefeitura Municipal de Olinda',
                    'uasg': '150002',
                    'objeto': 'Servi√ßos de limpeza',
                    'cidade': 'Olinda',
                    'uf': 'PE',
                    'data_inicio_propostas': '2025-01-03',
                    'data_fim_propostas': '2025-01-07',
                    'data_homologacao': '2025-01-08',
                    'fornecedor': 'Limpeza Brasil SP',
                    'cnpj_fornecedor': '34.567.890/0001-12',
                    'itens': [
                        {
                            'numero_item': '001',
                            'descricao': 'Servi√ßo de limpeza predial',
                            'quantidade': 1,
                            'valor_unitario': 5000.00,
                            'valor_total_item': 5000.00
                        }
                    ]
                }
            ];
        }

        // Carregar dados da API
        async function carregarDadosAPI() {
            try {
                console.log('üì° Conectando √† API:', CONFIG.API_URL);
                
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

                const response = await fetch(CONFIG.API_URL, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });

                clearTimeout(timeout);

                if (!response.ok) {
                    throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
                }

                const dados = await response.json();
                
                if (!Array.isArray(dados)) {
                    throw new Error('API retornou formato inv√°lido (n√£o √© array)');
                }

                console.log('‚úÖ Dados carregados com sucesso:', dados.length, 'registros');
                exibirAlerta('info', 'Sucesso', `${dados.length} licita√ß√µes carregadas da API`);
                
                return dados;

            } catch (erro) {
                console.error('‚ùå Erro ao carregar API:', erro);
                
                tentativaAtual++;
                if (tentativaAtual < CONFIG.RETRIES) {
                    console.log(`üîÑ Tentativa ${tentativaAtual}/${CONFIG.RETRIES}...`);
                    exibirAlerta('warning', 'Aviso', `Tentativa ${tentativaAtual}/${CONFIG.RETRIES} de reconex√£o...`);
                    
                    // Aguardar 2 segundos antes de tentar novamente
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    return carregarDadosAPI();
                } else {
                    console.error('‚ùå Todas as tentativas falharam');
                    exibirAlerta('danger', 'Erro de Conex√£o', 
                        'N√£o foi poss√≠vel conectar √† API. Usando dados de demonstra√ß√£o.');
                    return null;
                }
            }
        }

        // Fun√ß√£o principal de carregamento
        async function carregarDados() {
            mostrarLoading(true);
            tentativaAtual = 0;

            try {
                let dados = null;

                if (CONFIG.USE_MOCK_DATA) {
                    console.log('üìä Usando dados de teste (MOCK)');
                    exibirAlerta('info', 'Modo Teste', 'Usando dados de demonstra√ß√£o. Configure CONFIG.API_URL para usar dados reais.');
                    dados = obterDadosMock();
                } else {
                    console.log('üåê Tentando carregar da API...');
                    dados = await carregarDadosAPI();
                    
                    if (!dados) {
                        console.log('‚ö†Ô∏è API falhou, usando dados de teste');
                        dados = obterDadosMock();
                    }
                }

                // Processar dados
                if (dados && dados.length > 0) {
                    dadosOriginais = [...dados];
                    preencherFiltros(dados);
                    atualizarTabela(dados);
                    console.log('‚úÖ Dashboard carregado com', dados.length, 'registros');
                } else {
                    exibirAlerta('danger', 'Erro', 'Nenhum dado foi carregado');
                    atualizarCards(0, 0, 0, 0);
                }

            } catch (erro) {
                console.error('‚ùå Erro cr√≠tico:', erro);
                exibirAlerta('danger', 'Erro Cr√≠tico', erro.message);
                atualizarCards(0, 0, 0, 0);
            } finally {
                mostrarLoading(false);
            }
        }

        // ==================== PREENCHIMENTO DE FILTROS ====================

        function preencherFiltros(data) {
            const orgaos = new Set();
            const ufs = new Set();
            const uasgs = new Set();
            const fornecedores = new Set();

            data.forEach(lic => {
                if (lic.orgao_nome) orgaos.add(lic.orgao_nome);
                if (lic.uf) ufs.add(lic.uf);
                if (lic.uasg) uasgs.add(lic.uasg);
                if (lic.fornecedor) fornecedores.add(lic.fornecedor);
            });

            // Preencher √ìrg√£os
            const selectOrgao = document.getElementById('filtro-orgao');
            selectOrgao.innerHTML = '<option value="">Todos os √ìrg√£os</option>';
            Array.from(orgaos).sort().forEach(orgao => {
                const option = document.createElement('option');
                option.value = orgao;
                option.textContent = orgao;
                selectOrgao.appendChild(option);
            });

            // Preencher UFs
            const selectUf = document.getElementById('filtro-uf');
            selectUf.innerHTML = '<option value="">Todos os Estados</option>';
            Array.from(ufs).sort().forEach(uf => {
                const option = document.createElement('option');
                option.value = uf;
                option.textContent = uf;
                selectUf.appendChild(option);
            });

            // Preencher UASGs
            const selectUasg = document.getElementById('filtro-uasg');
            selectUasg.innerHTML = '<option value="">Todos os UASG</option>';
            Array.from(uasgs).sort().forEach(uasg => {
                const option = document.createElement('option');
                option.value = uasg;
                option.textContent = uasg;
                selectUasg.appendChild(option);
            });

            // Preencher Fornecedores
            const selectFornecedor = document.getElementById('filtro-fornecedor');
            selectFornecedor.innerHTML = '<option value="">Todos os Fornecedores</option>';
            Array.from(fornecedores).sort().forEach(fornecedor => {
                const option = document.createElement('option');
                option.value = fornecedor;
                option.textContent = fornecedor;
                selectFornecedor.appendChild(option);
            });
        }

        // ==================== APLICA√á√ÉO DE FILTROS ====================

        function aplicarFiltros() {
            const filtroOrgao = document.getElementById('filtro-orgao').value;
            const filtroUf = document.getElementById('filtro-uf').value;
            const filtroUasg = document.getElementById('filtro-uasg').value;
            const filtroFornecedor = document.getElementById('filtro-fornecedor').value;
            const filtroPregao = document.getElementById('filtro-pregao').value.toLowerCase();

            const dadosFiltrados = dadosOriginais.filter(lic => {
                const matchOrgao = !filtroOrgao || lic.orgao_nome === filtroOrgao;
                const matchUf = !filtroUf || lic.uf === filtroUf;
                const matchUasg = !filtroUasg || lic.uasg === filtroUasg;
                const matchFornecedor = !filtroFornecedor || lic.fornecedor === filtroFornecedor;
                const matchPregao = !filtroPregao || 
                    (lic.numero_pregao && lic.numero_pregao.toLowerCase().includes(filtroPregao)) ||
                    (lic.id_pncp && lic.id_pncp.toLowerCase().includes(filtroPregao));

                return matchOrgao && matchUf && matchUasg && matchFornecedor && matchPregao;
            });

            atualizarTabela(dadosFiltrados);
        }

        function limparFiltros() {
            document.getElementById('filtro-orgao').value = '';
            document.getElementById('filtro-uf').value = '';
            document.getElementById('filtro-uasg').value = '';
            document.getElementById('filtro-fornecedor').value = '';
            document.getElementById('filtro-pregao').value = '';
            atualizarTabela(dadosOriginais);
        }

        // ==================== ATUALIZA√á√ÉO DA TABELA ====================

        function atualizarTabela(dados) {
            let totalValor = 0;
            let totalItens = 0;
            const municipios = new Set();

            const corpo = document.getElementById('corpo-tabela');
            corpo.innerHTML = '';

            if (dados.length === 0) {
                corpo.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-message">
                                <i class="fas fa-search"></i>
                                <p>Nenhuma licita√ß√£o encontrada com esses filtros</p>
                            </div>
                        </td>
                    </tr>
                `;
                
                atualizarCards(0, 0, 0, 0);
                
                if (dataTable) {
                    dataTable.destroy();
                }
                dataTable = $('#tabela-licitacoes').DataTable({
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json'
                    }
                });
                return;
            }

            dados.forEach(lic => {
                municipios.add((lic.cidade || 'N/D') + '/' + (lic.uf || 'N/D'));

                const fornecedor = lic.fornecedor || 'N/D';

                if (lic.itens && lic.itens.length > 0) {
                    lic.itens.forEach(it => {
                        const valor = parseFloat(it.valor_total_item || 0);
                        totalValor += valor;
                        totalItens++;
                    });
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <small>${formatarData(lic.data_homologacao)}</small>
                    </td>
                    <td>
                        <strong>${lic.orgao_nome || 'N/D'}</strong><br>
                        <small class="text-muted">${lic.cidade || 'N/D'}, ${lic.uf || 'N/D'}</small>
                    </td>
                    <td>
                        <code>${lic.id_pncp || lic.numero_pregao || 'N/D'}</code>
                    </td>
                    <td>${formatarData(lic.data_inicio_propostas)}</td>
                    <td>${formatarData(lic.data_fim_propostas)}</td>
                    <td>
                        <span class="badge bg-success">${fornecedor}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary detalhes-btn" 
                                onclick="abrirDetalhes('${lic.id_pncp}')">
                            <i class="fas fa-eye"></i> Detalhes
                        </button>
                    </td>
                `;
                row.dataset.licData = JSON.stringify(lic);
                corpo.appendChild(row);
            });

            atualizarCards(dados.length, totalValor, totalItens, municipios.size);

            if (dataTable) {
                dataTable.destroy();
            }
            dataTable = $('#tabela-licitacoes').DataTable({
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json'
                },
                order: [[0, 'desc']],
                pageLength: 10,
                responsive: true
            });
        }

        function atualizarCards(totalLic, totalVal, totalIt, totalMun) {
            document.getElementById('total-lic').innerText = totalLic.toLocaleString('pt-BR');
            document.getElementById('total-val').innerText = formatarMoeda(totalVal);
            document.getElementById('total-itens').innerText = totalIt.toLocaleString('pt-BR');
            document.getElementById('total-mun').innerText = totalMun;
        }

        // ==================== MODAL DE DETALHES ====================

        function abrirDetalhes(idPncp) {
            const licData = dadosOriginais.find(lic => lic.id_pncp === idPncp);
            
            if (!licData) {
                alert('Licita√ß√£o n√£o encontrada');
                return;
            }

            let tabelaItensHtml = '';
            if (licData.itens && licData.itens.length > 0) {
                tabelaItensHtml = `
                    <h6 class="mt-4 mb-3">
                        <i class="fas fa-list"></i> Itens da Licita√ß√£o
                    </h6>
                    <table class="table table-modal table-sm">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Descri√ß√£o</th>
                                <th>Qtd</th>
                                <th>Valor Unit.</th>
                                <th>Valor Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${licData.itens.map(item => `
                                <tr>
                                    <td>${item.numero_item || '-'}</td>
                                    <td>${item.descricao || '-'}</td>
                                    <td>${item.quantidade || 0}</td>
                                    <td>${formatarMoeda(item.valor_unitario)}</td>
                                    <td><strong>${formatarMoeda(item.valor_total_item)}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            const html = `
                <div class="detail-row">
                    <div class="detail-item">
                        <span class="detail-label">ID PNCP</span>
                        <span class="detail-value">${licData.id_pncp || 'N/D'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">N¬∫ Preg√£o</span>
                        <span class="detail-value">${licData.numero_pregao || 'N/D'}</span>
                    </div>
                </div>

                <div class="detail-row full">
                    <div class="detail-item">
                        <span class="detail-label">√ìrg√£o</span>
                        <span class="detail-value">${licData.orgao_nome || 'N/D'}</span>
                    </div>
                </div>

                <div class="detail-row">
                    <div class="detail-item">
                        <span class="detail-label">Cidade</span>
                        <span class="detail-value">${licData.cidade || 'N/D'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Estado</span>
                        <span class="detail-value">${licData.uf || 'N/D'}</span>
                    </div>
                </div>

                <div class="detail-row">
                    <div class="detail-item">
                        <span class="detail-label">UASG</span>
                        <span class="detail-value">${licData.uasg || 'N/D'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">C√≥digo √ìrg√£o</span>
                        <span class="detail-value">${licData.orgao_codigo || 'N/D'}</span>
                    </div>
                </div>

                <div class="detail-row full">
                    <div class="detail-item">
                        <span class="detail-label">Objeto</span>
                        <span class="detail-value">${licData.objeto || 'N/D'}</span>
                    </div>
                </div>

                <div class="detail-row">
                    <div class="detail-item">
                        <span class="detail-label">Data In√≠cio</span>
                        <span class="detail-value">${formatarData(licData.data_inicio_propostas)}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Data Fim</span>
                        <span class="detail-value">${formatarData(licData.data_fim_propostas)}</span>
                    </div>
                </div>

                <div class="detail-row">
                    <div class="detail-item">
                        <span class="detail-label">Data Homologa√ß√£o</span>
                        <span class="detail-value">${formatarData(licData.data_homologacao)}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Fornecedor Principal</span>
                        <span class="detail-value">${licData.fornecedor || 'N/D'}</span>
                    </div>
                </div>

                <div class="detail-row full">
                    <div class="detail-item">
                        <span class="detail-label">CNPJ Fornecedor</span>
                        <span class="detail-value">${licData.cnpj_fornecedor || 'N/D'}</span>
                    </div>
                </div>

                ${tabelaItensHtml}
            `;

            document.getElementById('modalBody').innerHTML = html;
            const modal = new bootstrap.Modal(document.getElementById('detalhesModal'));
            modal.show();
        }

        // ==================== EVENT LISTENERS ====================

        document.getElementById('btn-filtrar').addEventListener('click', aplicarFiltros);
        document.getElementById('btn-limpar-filtros').addEventListener('click', limparFiltros);

        document.getElementById('filtro-pregao').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') aplicarFiltros();
        });

        // ==================== INICIALIZA√á√ÉO ====================

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Dashboard iniciando...');
            console.log('Configura√ß√£o:', CONFIG);
            carregarDados();
        });
    </script>
</body>
</html>
