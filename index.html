<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Ranking Inteligente PNCP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { border-top-color: #3b82f6; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .detalhes-row { display: none; background-color: #f8fafc; }
        .detalhes-row.active { display: table-row; }
    </style>
</head>
<body class="bg-slate-50 p-4">

    <div class="max-w-7xl mx-auto">
        <header class="bg-white p-6 rounded-2xl shadow-sm mb-6 flex justify-between items-center border border-slate-200">
            <div>
                <h1 class="text-2xl font-black text-slate-800 tracking-tight">ðŸ“Š Painel de ConcorrÃªncia</h1>
                <div id="status" class="mt-2 text-[10px] font-bold px-3 py-1 rounded-full bg-blue-50 text-blue-600 border border-blue-100 uppercase inline-block">Inicializando...</div>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <input type="text" id="filtro" placeholder="Buscar Ã“rgÃ£o ou Edital..." class="p-4 rounded-xl border-none shadow-sm ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 outline-none">
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
                <p class="text-[10px] uppercase font-bold text-slate-400">Processos</p>
                <div id="count" class="text-2xl font-black text-slate-700">0</div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-emerald-500">
                <p class="text-[10px] uppercase font-bold text-slate-400">Volume Total</p>
                <div id="totalFinanceiro" class="text-2xl font-black text-emerald-600">R$ 0,00</div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-slate-200">
            <table class="min-w-full">
                <thead class="bg-slate-900 text-white text-[10px] uppercase font-bold">
                    <tr>
                        <th class="px-6 py-4 text-left">Edital / UASG</th>
                        <th class="px-6 py-4 text-left">Ã“rgÃ£o</th>
                        <th class="px-6 py-4 text-right">Valor Total</th>
                    </tr>
                </thead>
                <tbody id="corpo" class="text-sm divide-y divide-slate-100"></tbody>
            </table>
        </div>
    </div>

    <div id="spinner" class="fixed inset-0 bg-white/95 flex flex-col items-center justify-center z-50">
        <div class="loading w-12 h-12 border-4 border-slate-200 rounded-full mb-4"></div>
        <p id="spinnerText" class="text-slate-500 font-bold text-xs uppercase tracking-widest">A carregar dados...</p>
    </div>

    <script>
        let db = [];

        async function init() {
            const statusEl = document.getElementById('status');
            const spinnerText = document.getElementById('spinnerText');

            try {
                spinnerText.innerText = "A descarregar ficheiro...";
                const res = await fetch('dados_pncp.zip?v=' + Date.now());
                if (!res.ok) throw new Error("Ficheiro dados_pncp.zip nÃ£o encontrado.");

                const blob = await res.blob();
                const zip = await JSZip.loadAsync(blob);

                // LÃ³gica Inteligente: Procura qualquer ficheiro .json dentro do ZIP
                const jsonFileName = Object.keys(zip.files).find(name => name.endsWith('.json'));
                
                if (!jsonFileName) throw new Error("NÃ£o foi encontrado nenhum ficheiro JSON dentro do ZIP.");

                spinnerText.innerText = "A processar conteÃºdos...";
                const text = await zip.file(jsonFileName).async("string");
                db = JSON.parse(text);

                document.getElementById('spinner').classList.add('hidden');
                statusEl.innerText = "SISTEMA ONLINE";
                render(db);

            } catch (e) {
                console.error(e);
                document.getElementById('spinner').innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-lg text-center max-w-sm">
                        <p class="text-red-500 font-bold mb-4">ERRO DE CARREGAMENTO</p>
                        <p class="text-slate-500 text-xs mb-4">${e.message}</p>
                        <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold">Tentar Novamente</button>
                    </div>`;
            }
        }

        function render(dados) {
            const corpo = document.getElementById('corpo');
            corpo.innerHTML = "";
            let soma = 0;

            dados.forEach((lic, i) => {
                soma += (lic.total_licitacao || 0);
                
                const fornecedoresHtml = (lic.itens || []).map(it => `
                    <div class="flex justify-between text-[11px] border-b border-slate-50 py-1">
                        <span>Item ${it.item}: ${it.fornecedor}</span>
                        <span class="font-bold">R$ ${it.total.toLocaleString('pt-br')}</span>
                    </div>
                `).join('');

                corpo.innerHTML += `
                    <tr class="cursor-pointer hover:bg-blue-50" onclick="document.getElementById('d-${i}').classList.toggle('active')">
                        <td class="px-6 py-4"><b class="text-blue-600">${lic.edital}</b><div class="text-[10px] text-slate-300">UASG: ${lic.uasg}</div></td>
                        <td class="px-6 py-4"><div class="font-bold text-slate-700 uppercase text-xs">${lic.orgao}</div><div class="text-[10px] text-slate-400">${lic.uf}</div></td>
                        <td class="px-6 py-4 text-right font-black text-slate-700">R$ ${lic.total_licitacao.toLocaleString('pt-br')}</td>
                    </tr>
                    <tr id="d-${i}" class="detalhes-row">
                        <td colspan="3" class="p-6">
                            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-inner">
                                <h4 class="text-[10px] font-black text-slate-400 uppercase mb-3">Vencedores por Item</h4>
                                ${fornecedoresHtml}
                                <div class="mt-4"><a href="${lic.link_edital}" target="_blank" class="bg-slate-800 text-white px-3 py-1 rounded text-[10px] font-bold uppercase">Ver no PNCP</a></div>
                            </div>
                        </td>
                    </tr>`;
            });

            document.getElementById('count').innerText = dados.length;
            document.getElementById('totalFinanceiro').innerText = soma.toLocaleString('pt-br', {style:'currency', currency:'BRL'});
        }

        document.getElementById('filtro').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            render(db.filter(d => d.orgao.toLowerCase().includes(val) || d.edital.toLowerCase().includes(val)));
        });

        init();
    </script>
</body>
</html>
