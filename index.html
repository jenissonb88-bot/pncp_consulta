<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel PNCP Sniper 2026 - Licita√ß√µes e Preg√µes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary: #667eea;
            --success: #28a745;
            --info: #17a2b8;
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .header-bg { 
            background: var(--primary-gradient); 
            color: white; 
            padding: 2.5rem 0; 
            margin-bottom: 2rem; 
            box-shadow: 0 10px 30px rgba(102,126,234,0.3);
        }
        
        .card-licitacao { 
            border: none; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
            margin-bottom: 1.5rem; 
            transition: all 0.3s ease; 
            background: white;
            overflow: hidden;
        }
        
        .card-licitacao:hover { 
            transform: translateY(-8px); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.15); 
        }
        
        .num-pregao-destaque { 
            font-size: 1.4rem; 
            font-weight: 800; 
            background: var(--primary-gradient); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        
        .orgao-nome { 
            color: #1a202c; 
            font-weight: 600; 
            font-size: 1.1rem; 
            margin-bottom: 0.25rem;
        }
        
        .fornecedor-nome { 
            color: var(--success); 
            font-weight: 600; 
            font-size: 1rem;
            background: rgba(40,167,69,0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            display: inline-block;
        }
        
        .valor-total { 
            font-size: 1.3rem; 
            font-weight: 700; 
            color: var(--success); 
            margin-bottom: 0.25rem;
        }
        
        .info-prazos { 
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); 
            border-radius: 12px; 
            padding: 1.25rem; 
            margin-bottom: 1.25rem; 
            border-left: 5px solid var(--primary);
        }
        
        .info-label { 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            color: #64748b; 
            font-weight: 600; 
            letter-spacing: 0.5px;
            display: block; 
            margin-bottom: 0.25rem;
        }
        
        .info-value { 
            font-size: 0.95rem; 
            font-weight: 600; 
            color: #1e293b;
        }
        
        .id-pncp { 
            font-family: 'Courier New', monospace; 
            background: #f1f5f9; 
            color: #475569; 
            padding: 0.5rem 0.75rem; 
            border-radius: 8px; 
            font-size: 0.85rem;
            display: inline-block;
        }
        
        .status-badge { 
            font-size: 0.8rem; 
            padding: 0.4em 0.8em; 
            border-radius: 20px; 
            font-weight: 600;
        }
        
        .status-eletronico { 
            background: rgba(13,202,240,0.2); 
            color: #0c5460;
        }
        
        .table-itens { 
            margin: 0; 
            font-size: 0.9rem;
        }
        
        .table-itens th { 
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); 
            border: none; 
            font-weight: 600; 
            color: #64748b;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            padding: 1rem 0.75rem;
        }
        
        .table-itens td { 
            border-color: #f1f5f9;
            padding: 0.875rem 0.75rem;
            vertical-align: middle;
        }
        
        .btn-expandir { 
            border-radius: 25px; 
            font-weight: 500; 
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 0.5rem 1.25rem;
        }
        
        .btn-expandir:hover { 
            background: var(--primary); 
            color: white;
            transform: translateY(-1px);
        }
        
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
        }
        
        #searchInput {
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            padding: 0.75rem 1rem;
            font-size: 1rem;
        }
        
        #searchInput:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
    </style>
</head>
<body>

    <div class="header-bg">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h1 class="fw-bold mb-1"><i class="fas fa-bullseye me-3"></i>PNCP Sniper 2026</h1>
                    <p class="mb-0 opacity-90 fs-6">Monitoramento Inteligente de Preg√µes e Licita√ß√µes P√∫blicas</p>
                </div>
                <div class="text-end">
                    <span class="badge bg-white text-primary fs-5 px-3 py-2 shadow-sm" id="total-valor">R$ 0,00</span>
                    <div class="mt-2 opacity-80" id="last-update">Carregando...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container pb-5">
        <div class="row g-4 mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="stat-card h-100">
                    <div class="text-muted small text-uppercase fw-bold mb-2">Preg√µes Monitorados</div>
                    <div class="h2 mb-1 fw-bold text-primary" id="count-pregoes">0</div>
                    <small class="text-muted">Total de processos</small>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card h-100">
                    <div class="text-muted small text-uppercase fw-bold mb-2">Itens Licitados</div>
                    <div class="h2 mb-1 fw-bold text-success" id="count-itens">0</div>
                    <small class="text-muted">Produtos/Servi√ßos</small>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card h-100">
                    <div class="text-muted small text-uppercase fw-bold mb-2">Munic√≠pios</div>
                    <div class="h2 mb-1 fw-bold text-info" id="count-municipios">0</div>
                    <small class="text-muted">Cidades √∫nicas</small>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card h-100 d-flex flex-column justify-content-center">
                    <input type="text" id="searchInput" class="form-control form-control-lg" placeholder="üîç N¬∫ Preg√£o, √ìrg√£o ou Cidade...">
                </div>
            </div>
        </div>

        <div id="loading" class="text-center py-5 d-none">
            <div class="spinner-border text-primary fs-1 mb-3" role="status"></div>
            <p class="text-muted fs-5">Conectando com PNCP...</p>
        </div>

        <div id="container-licitacoes"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const formatMoney = (value) => {
            return parseFloat(value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };

        const formatDate = (dateStr) => {
            if (!dateStr) return '<span class="text-muted small">N/D</span>';
            try {
                const date = new Date(dateStr);
                if (isNaN(date)) return dateStr;
                return date.toLocaleDateString('pt-BR') + '<br><small class="opacity-75">' + 
                       date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}) + '</small>';
            } catch {
                return dateStr;
            }
        };

        let dadosGlobais = [];
        let todosFornecedores = {}; // Cache de nomes de fornecedores

        async function carregarDados() {
            document.getElementById('loading').classList.remove('d-none');
            
            try {
                // Tenta API PNCP real
                const response = await fetch('https://api.pncp.gov.br/v1/licitacoes?_limit=100', {
                    headers: { 'Accept': 'application/json' }
                });
                
                let dados = [];
                if (response.ok) {
                    dados = await response.json();
                    // Processa resumo_fornecedores para nomes reais
                    dados.forEach(lic => {
                        if (lic.resumo_fornecedores) {
                            Object.entries(lic.resumo_fornecedores).forEach(([cnpj, info]) => {
                                if (!todosFornecedores[cnpj]) {
                                    todosFornecedores[cnpj] = info.fornecedor_nome || `Fornecedor ${cnpj.slice(-6)}`;
                                }
                            });
                        }
                    });
                } else {
                    dados = obterDadosMock();
                }

                dadosGlobais = dados.filter(d => d.numero_pregao); // S√≥ com preg√£o
                dadosGlobais.sort((a, b) => new Date(b.data_resultado || b.data_homologacao || 0) - new Date(a.data_resultado || a.data_homologacao || 0));

                atualizarDashboard(dadosGlobais);
                renderizarLista(dadosGlobais);
                
            } catch (error) {
                console.error('Erro API:', error);
                dadosGlobais = obterDadosMock();
                atualizarDashboard(dadosGlobais);
                renderizarLista(dadosGlobais);
            } finally {
                document.getElementById('loading').classList.add('d-none');
            }
        }

        function obterDadosMock() {
            return [
                {
                    id_licitacao: "08084014000142000572024",
                    numero_pregao: "25/2024",
                    orgao_nome: "MUNIC√çPIO DE CAMPO GRANDE",
                    orgao_codigo: "08084014000142",
                    uasg: "08084014000142",
                    cidade: "Campo Grande",
                    uf: "RN",
                    objeto: "AQUISI√á√ÉO DE MATERIAIS PERMANENTE DESTINADOS AO DESENVOLVIMENTO DO ENSINO FUNDAMENTAL",
                    link_edital: "https://pncp.gov.br/app/editais/08084014000142/2024/57",
                    data_resultado: "2025-01-02T04:11:23",
                    cnpj_fornecedor: "08778201000126",
                    fornecedor_nome: "EDUCAMAZONAS COM√âRCIO E SERVI√áOS LTDA",
                    tipo: "eletronico",
                    itens: [
                        {numero_item: "001", descricao: "Materiais permanentes educa√ß√£o", quantidade: 50, valor_unitario: 250.00, valor_total: 12500.00}
                    ]
                },
                {
                    id_licitacao: "08778201000126",
                    numero_pregao: "20250101-0001",
                    orgao_nome: "Universidade Federal de Pernambuco",
                    orgao_codigo: "26296",
                    uasg: "150000",
                    cidade: "Recife",
                    uf: "PE",
                    objeto: "Fornecimento de medicamentos",
                    link_edital: "https://pncp.gov.br/app/editais/26296/2025/1",
                    data_resultado: "2025-01-05",
                    cnpj_fornecedor: "12345678000190",
                    fornecedor_nome: "FARMAC√äUTICA XYZ LTDA",
                    tipo: "eletronico",
                    itens: [
                        {numero_item: "001", descricao: "Paracetamol 500mg cx 20", quantidade: 100, valor_unitario: 1.50, valor_total: 150.00}
                    ]
                },
                {
                    id_licitacao: "08778201000127",
                    numero_pregao: "20250102-0002",
                    orgao_nome: "Secretaria de Educa√ß√£o de Pernambuco",
                    orgao_codigo: "26297",
                    uasg: "150001",
                    cidade: "Recife",
                    uf: "PE",
                    objeto: "Aquisi√ß√£o de material de escrit√≥rio",
                    link_edital: "https://pncp.gov.br/app/editais/26297/2025/2",
                    data_resultado: "2025-01-06",
                    cnpj_fornecedor: "23456789000101",
                    fornecedor_nome: "PAPELARIA ABC LTDA",
                    tipo: "eletronico",
                    itens: [
                        {numero_item: "001", descricao: "Papel A4 Resma 75g", quantidade: 50, valor_unitario: 25.00, valor_total: 1250.00},
                        {numero_item: "002", descricao: "Caneta esferogr√°fica azul", quantidade: 500, valor_unitario: 0.50, valor_total: 250.00}
                    ]
                }
            ];
        }

        function atualizarDashboard(dados) {
            let totalVal = 0, totalItens = 0, munSet = new Set();
            
            dados.forEach(lic => {
                munSet.add(lic.cidade);
                lic.itens?.forEach(item => {
                    totalVal += item.valor_total || 0;
                    totalItens++;
                });
            });

            document.getElementById('total-valor').innerText = formatMoney(totalVal);
            document.getElementById('count-pregoes').innerText = dados.length;
            document.getElementById('count-itens').innerText = totalItens;
            document.getElementById('count-municipios').innerText = munSet.size;
            
            const agora = new Date();
            document.getElementById('last-update').innerText = 
                'Atualizado: ' + agora.toLocaleDateString('pt-BR') + ' ' + agora.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
        }

        function renderizarLista(dados) {
            const container = document.getElementById('container-licitacoes');
            container.innerHTML = '';

            if (!dados.length) {
                container.innerHTML = `
                    <div class="text-center py-5 my-5">
                        <i class="fas fa-search fa-4x text-muted mb-4"></i>
                        <h4 class="text-muted mb-1">Nenhum preg√£o encontrado</h4>
                        <p class="text-muted">Tente buscar por n√∫mero do preg√£o, √≥rg√£o ou cidade</p>
                    </div>
                `;
                return;
            }

            dados.forEach((lic, index) => {
                const totalLic = lic.itens?.reduce((acc, it) => acc + (it.valor_total || 0), 0) || 0;
                const fornecedorNome = lic.fornecedor_nome || todosFornecedores[lic.cnpj_fornecedor] || `CNPJ ${lic.cnpj_fornecedor?.slice(-8)}`;
                
                const card = document.createElement('div');
                card.className = 'card-licitacao';
                card.innerHTML = `
                    <div class="p-4">
                        <div class="row align-items-start">
                            <div class="col-auto">
                                <div class="bg-gradient rounded-circle d-flex align-items-center justify-content-center text-white" 
                                     style="width: 56px; height: 56px;">
                                    <i class="fas fa-gavel fs-5"></i>
                                </div>
                            </div>
                            <div class="col">
                                <div class="num-pregao-destaque mb-2">${lic.numero_pregao}</div>
                                <div class="orgao-nome mb-2">${lic.orgao_nome}</div>
                                <div class="mb-3">
                                    <i class="fas fa-map-marker-alt text-muted me-2"></i>
                                    <span class="fw-medium">${lic.cidade} - ${lic.uf}</span>
                                    <span class="badge bg-secondary ms-2">UASG: ${lic.uasg}</span>
                                </div>
                                <div class="fornecedor-nome mb-3">${fornecedorNome}</div>
                            </div>
                            <div class="col-auto text-end">
                                <div class="valor-total mb-2">${formatMoney(totalLic)}</div>
                                <div class="small text-muted mb-2">${lic.itens?.length || 0} itens</div>
                                <div>
                                    <a href="${lic.link_edital || '#'}" target="_blank" class="btn btn-outline-primary btn-sm me-2">
                                        <i class="fas fa-external-link-alt"></i> Edital
                                    </a>
                                    <button class="btn btn-primary btn-sm btn-expandir" type="button" 
                                            data-bs-toggle="collapse" data-bs-target="#collapse-${index}">
                                        <i class="fas fa-chevron-down"></i> Detalhes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="collapse" id="collapse-${index}">
                        <div class="info-prazos px-4 pb-4">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <span class="info-label"><i class="fas fa-calendar-check me-1"></i>Data Resultado</span>
                                    <div class="info-value">${formatDate(lic.data_resultado)}</div>
                                </div>
                                <div class="col-md-3">
                                    <span class="info-label"><i class="far fa-calendar me-1"></i>√çnicio Propostas</span>
                                    <div class="info-value">${formatDate(lic.data_inicio_propostas)}</div>
                                </div>
                                <div class="col-md-3">
                                    <span class="info-label"><i class="far fa-calendar-times me-1"></i>Fim Propostas</span>
                                    <div class="info-value">${formatDate(lic.data_fim_propostas)}</div>
                                </div>
                                <div class="col-md-3">
                                    <span class="info-label"><i class="fas fa-fingerprint me-1"></i>ID PNCP</span>
                                    <div class="info-value"><span class="id-pncp">${lic.id_pncp || 'N/A'}</span></div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-8">
                                    <span class="info-label">Objeto da Licita√ß√£o</span>
                                    <div class="info-value" style="line-height: 1.5;">${lic.objeto}</div>
                                </div>
                                <div class="col-md-4">
                                    <span class="info-label">CNPJ Vencedor</span>
                                    <div class="info-value">${lic.cnpj_fornecedor}</div>
                                </div>
                            </div>
                        </div>

                        ${lic.itens && lic.itens.length ? `
                        <div class="table-responsive px-4 pb-4">
                            <table class="table table-itens">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Descri√ß√£o</th>
                                        <th class="text-center">Qtd</th>
                                        <th class="text-end">Unit√°rio</th>
                                        <th class="text-end">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${lic.itens.map(item => `
                                        <tr>
                                            <td class="fw-bold text-center">${item.numero_item}</td>
                                            <td class="text-truncate" style="max-width: 300px;" title="${item.descricao}">
                                                ${item.descricao}
                                            </td>
                                            <td class="text-center fw-medium">${item.quantidade || 0}</td>
                                            <td class="text-end text-muted small">${formatMoney(item.valor_unitario)}</td>
                                            <td class="text-end fw-bold text-success fs-6">${formatMoney(item.valor_total)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ` : `
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-info-circle fa-2x mb-2"></i>
                            <div>Itens n√£o dispon√≠veis</div>
                        </div>
                        `}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Busca otimizada (prioriza preg√£o)
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const termo = e.target.value.toLowerCase().trim();
            const filtrados = dadosGlobais.filter(lic => 
                (lic.numero_pregao && lic.numero_pregao.toLowerCase().includes(termo)) ||
                lic.orgao_nome.toLowerCase().includes(termo) ||
                (lic.fornecedor_nome && lic.fornecedor_nome.toLowerCase().includes(termo)) ||
                lic.cidade.toLowerCase().includes(termo) ||
                lic.uf.includes(termo.toUpperCase()) ||
                (lic.uasg && lic.uasg.includes(termo))
            );
            renderizarLista(filtrados);
        });

        // Auto-refresh
        setInterval(carregarDados, 10 * 60 * 1000);

        // Inicializar
        document.addEventListener('DOMContentLoaded', carregarDados);
    </script>
</body>
</html>
