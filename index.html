<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Consulta PNCP - Pregão Eletrônico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: #003366;
      color: #fff;
      padding: 16px;
      text-align: center;
    }

    main {
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
      background-color: #fff;
    }

    h1 {
      margin: 0;
      font-size: 1.6rem;
    }

    h2 {
      margin-top: 0;
      font-size: 1.2rem;
    }

    #status-carregamento {
      margin-bottom: 12px;
      font-size: 0.95rem;
      color: #555;
    }

    #tabela-licitacoes {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.92rem;
    }

    #tabela-licitacoes th,
    #tabela-licitacoes td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      vertical-align: top;
    }

    #tabela-licitacoes th {
      background-color: #e0e6f0;
      text-align: left;
    }

    .linha-licitacao {
      background-color: #f0f4ff;
      font-weight: bold;
    }

    .linha-item {
      background-color: #fafafa;
    }

    .item-sem-resultado {
      background-color: #ffe9e9;
      color: #b30000;
    }

    .linha-totais {
      background-color: #e9fbe9;
      font-style: italic;
    }

    .situacao {
      font-weight: bold;
      margin-left: 4px;
    }

    a {
      color: #003366;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    @media (max-width: 768px) {
      #tabela-licitacoes {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Consulta PNCP - Pregão Eletrônico</h1>
  </header>

  <main>
    <h2>Licitações e Itens (CNPJ monitorado)</h2>
    <div id="status-carregamento">Carregando dados do PNCP...</div>

    <table id="tabela-licitacoes">
      <thead>
        <tr>
          <th>Órgão/UASG</th>
          <th>Nome do órgão</th>
          <th>Nº Pregão</th>
          <th>ID PNCP</th>
          <th>Propostas (Início/Fim)</th>
          <th>Cidade/UF</th>
          <th>Objeto</th>
        </tr>
      </thead>
      <tbody id="corpo-tabela">
        <!-- Linhas preenchidas via JavaScript -->
      </tbody>
    </table>
  </main>

  <script>
    async function carregarDadosPncp() {
      const status = document.getElementById('status-carregamento');
      try {
        const resp = await fetch('dados_pncp.json', { cache: 'no-store' });
        if (!resp.ok) {
          status.textContent = 'Não foi possível carregar o arquivo dados_pncp.json.';
          console.error('Erro HTTP ao carregar dados_pncp.json:', resp.status);
          return;
        }

        const licitacoes = await resp.json();
        const corpo = document.getElementById('corpo-tabela');
        corpo.innerHTML = '';

        if (!Array.isArray(licitacoes) || licitacoes.length === 0) {
          status.textContent = 'Nenhuma licitação encontrada para o período/critério configurado.';
          return;
        }

        status.textContent = `Total de licitações encontradas: ${licitacoes.length}.`;

        licitacoes.forEach(lic => {
          // Linha principal da licitação
          const trLic = document.createElement('tr');
          trLic.classList.add('linha-licitacao');

          const orgaoUasg = `${lic.orgao_codigo || ''} / ${lic.uasg || ''}`;
          const periodo = `${formatarData(lic.data_inicio_propostas)} a ${formatarData(lic.data_fim_propostas)}`;
          const cidadeUf = `${lic.cidade || ''}/${lic.uf || ''}`;

          trLic.innerHTML = `
            <td>${orgaoUasg}</td>
            <td>${lic.orgao_nome || ''}</td>
            <td>${lic.numero_pregao || ''}</td>
            <td>
              <a href="${lic.link_edital || '#'}" target="_blank" rel="noopener noreferrer">
                ${lic.id_pncp || ''}
              </a>
            </td>
            <td>${periodo}</td>
            <td>${cidadeUf}</td>
            <td>${lic.objeto || ''}</td>
          `;
          corpo.appendChild(trLic);

          // Linhas dos itens
          if (Array.isArray(lic.itens)) {
            lic.itens.forEach(item => {
              const trItem = document.createElement('tr');
              trItem.classList.add('linha-item');

              if (item.situacao === 'SemResultado') {
                trItem.classList.add('item-sem-resultado');
              }

              trItem.innerHTML = `
                <td colspan="2">
                  Item ${item.numero_item || ''} - ${item.descricao || ''}
                </td>
                <td>${formatarData(item.data_homologacao)}</td>
                <td>Qtd: ${item.quantidade ?? ''}</td>
                <td>Unitário: ${formatarMoeda(item.valor_unitario)}</td>
                <td>${item.fornecedor || ''}</td>
                <td>
                  Total: ${formatarMoeda(item.valor_total_item)}
                  <span class="situacao">${item.situacao || ''}</span>
                </td>
              `;
              corpo.appendChild(trItem);
            });
          }

          // Linha de totais por fornecedor
          if (Array.isArray(lic.totais_fornecedor) && lic.totais_fornecedor.length > 0) {
            const trTotais = document.createElement('tr');
            trTotais.classList.add('linha-totais');

            const cel = document.createElement('td');
            cel.colSpan = 7;

            const partes = lic.totais_fornecedor.map(tf => {
              return `${tf.fornecedor}: ${formatarMoeda(tf.valor_total_fornecedor)}`;
            });

            cel.textContent = 'Totais por fornecedor: ' + partes.join(' | ');
            trTotais.appendChild(cel);
            corpo.appendChild(trTotais);
          }
        });
      } catch (e) {
        const statusEl = document.getElementById('status-carregamento');
        statusEl.textContent = 'Erro ao processar dados do PNCP.';
        console.error('Erro ao processar dados PNCP:', e);
      }
    }

    function formatarData(iso) {
      if (!iso) return '';
      try {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return iso;
        const dia = String(d.getDate()).padStart(2, '0');
        const mes = String(d.getMonth() + 1).padStart(2, '0');
        const ano = d.getFullYear();
        return `${dia}/${mes}/${ano}`;
      } catch {
        return iso;
      }
    }

    function formatarMoeda(valor) {
      if (valor === null || valor === undefined || valor === '') return '';
      const num = Number(valor);
      if (isNaN(num)) return String(valor);
      return num.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      });
    }

    document.addEventListener('DOMContentLoaded', carregarDadosPncp);
  </script>
</body>
</html>
