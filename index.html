<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Ranking Inteligente PNCP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { border-top-color: #3b82f6; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .detalhes-row { display: none; }
        .detalhes-row.active { display: table-row; }
    </style>
</head>
<body class="bg-slate-100 p-4 font-sans">
    <div class="max-w-7xl mx-auto">
        <header class="bg-white p-6 rounded-2xl shadow-sm mb-6 flex justify-between items-center border border-slate-200">
            <div>
                <h1 class="text-2xl font-black text-slate-800">ðŸ“Š InteligÃªncia de ConcorrÃªncia</h1>
                <p class="text-slate-500 text-sm font-medium italic">Dados agrupados por vencedor e item homologado</p>
            </div>
            <div id="status" class="px-4 py-2 rounded-full bg-blue-50 text-blue-600 text-xs font-bold border border-blue-100">Carregando...</div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <input type="text" id="filtro" placeholder="Filtrar Ã“rgÃ£o, Edital ou UASG..." class="md:col-span-2 p-4 rounded-xl border-none shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
                <p class="text-[10px] uppercase font-bold text-slate-400">Processos</p>
                <div id="count" class="text-xl font-black text-slate-700">0</div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-emerald-500">
                <p class="text-[10px] uppercase font-bold text-slate-400">Total Analisado</p>
                <div id="totalFinanceiro" class="text-xl font-black text-emerald-600">R$ 0,00</div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-slate-200">
            <table class="min-w-full">
                <thead class="bg-slate-800 text-white text-[10px] uppercase tracking-tighter">
                    <tr>
                        <th class="px-6 py-4 text-left">Edital / UASG</th>
                        <th class="px-6 py-4 text-left">Ã“rgÃ£o</th>
                        <th class="px-6 py-4 text-left">Principais Vencedores</th>
                        <th class="px-6 py-4 text-right">Valor Total</th>
                    </tr>
                </thead>
                <tbody id="corpo" class="text-sm divide-y divide-slate-100"></tbody>
            </table>
        </div>
    </div>

    <div id="spinner" class="fixed inset-0 bg-white/90 flex flex-col items-center justify-center z-50">
        <div class="loading w-12 h-12 border-4 border-slate-200 rounded-full mb-4"></div>
        <p class="text-slate-500 font-bold animate-pulse">Extraindo base de dados...</p>
    </div>

    <script>
        let db = [];

        async function init() {
            try {
                const res = await fetch('dados_pncp.zip?v=' + Date.now());
                const zip = await JSZip.loadAsync(await res.blob());
                db = JSON.parse(await zip.file("dados_pncp.json").async("string"));
                document.getElementById('spinner').remove();
                document.getElementById('status').innerText = "BASE SINCRONIZADA";
                render(db);
            } catch (e) { document.getElementById('status').innerText = "ERRO AO CARREGAR"; }
        }

        function render(dados) {
            const corpo = document.getElementById('corpo');
            corpo.innerHTML = "";
            let soma = 0;

            dados.forEach((lic, i) => {
                soma += (lic.total_licitacao || 0);
                const resumo = Object.entries(lic.resumo || {}).sort((a,b)=>b[1]-a[1]).slice(0,2)
                    .map(([n,v])=>`<div class="text-[10px]"><b>${n.substring(0,15)}:</b> R$ ${v.toLocaleString('pt-br')}</div>`).join('');

                // Agrupamento por Fornecedor
                const grupos = (lic.itens || []).reduce((acc, it) => {
                    if (!acc[it.fornecedor]) acc[it.fornecedor] = { items: [], sub: 0, cnpj: it.cnpj, alvo: it.e_alvo };
                    acc[it.fornecedor].items.push(it);
                    acc[it.fornecedor].sub += it.total;
                    return acc;
                }, {});

                const htmlDetalhes = Object.entries(grupos).map(([nome, info]) => `
                    <div class="mb-4 bg-white rounded-lg border border-slate-200 overflow-hidden shadow-sm">
                        <div class="bg-slate-50 p-3 border-b flex justify-between items-center">
                            <span class="font-bold ${info.alvo ? 'text-orange-600' : 'text-slate-700'}">${nome} <small class="text-slate-400 font-normal">(${info.cnpj})</small></span>
                            <span class="font-black text-slate-800">R$ ${info.sub.toLocaleString('pt-br')}</span>
                        </div>
                        <table class="w-full text-[10px] text-left">
                            <thead class="text-slate-400 border-b">
                                <tr>
                                    <th class="p-2">Item</th>
                                    <th class="p-2">DescriÃ§Ã£o</th>
                                    <th class="p-2 text-center">Data Homo</th>
                                    <th class="p-2 text-center">Qtd</th>
                                    <th class="p-2 text-right">UnitÃ¡rio</th>
                                    <th class="p-2 text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${info.items.map(it => `
                                    <tr class="border-b border-slate-50 hover:bg-slate-50">
                                        <td class="p-2 font-bold text-slate-400">#${it.item}</td>
                                        <td class="p-2 text-slate-600">${it.desc}</td>
                                        <td class="p-2 text-center text-slate-500">${it.data_homo}</td>
                                        <td class="p-2 text-center">${it.qtd}</td>
                                        <td class="p-2 text-right">R$ ${it.unitario.toLocaleString('pt-br', {minimumFractionDigits:4})}</td>
                                        <td class="p-2 text-right font-bold">R$ ${it.total.toLocaleString('pt-br')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `).join('');

                corpo.innerHTML += `
                    <tr class="cursor-pointer hover:bg-blue-50" onclick="document.getElementById('d-${i}').classList.toggle('active')">
                        <td class="px-6 py-4"><b class="text-blue-600">${lic.edital}</b><div class="text-[10px] font-mono text-slate-300">${lic.uasg}</div></td>
                        <td class="px-6 py-4"><div class="font-bold text-slate-700 uppercase text-xs">${lic.orgao}</div><div class="text-[10px] text-slate-400">${lic.cidade}/${lic.uf}</div></td>
                        <td class="px-6 py-4">${resumo}</td>
                        <td class="px-6 py-4 text-right font-black text-slate-700">R$ ${lic.total_licitacao.toLocaleString('pt-br')}</td>
                    </tr>
                    <tr id="d-${i}" class="detalhes-row bg-slate-50/50">
                        <td colspan="4" class="p-6">
                            <div class="flex justify-between mb-4"><h3 class="font-black text-slate-500 text-xs uppercase tracking-widest">Detalhamento por Vencedor</h3><a href="${lic.link_edital}" target="_blank" class="bg-slate-800 text-white px-3 py-1 rounded text-[10px] font-bold">Ver no PNCP</a></div>
                            ${htmlDetalhes}
                        </td>
                    </tr>
                `;
            });
            document.getElementById('count').innerText = dados.length;
            document.getElementById('totalFinanceiro').innerText = soma.toLocaleString('pt-br', {style:'currency', currency:'BRL'});
        }

        document.getElementById('filtro').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            render(db.filter(d => d.orgao.toLowerCase().includes(val) || d.edital.toLowerCase().includes(val) || d.uasg.includes(val)));
        });

        init();
    </script>
</body>
</html>
