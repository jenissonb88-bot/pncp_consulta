<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Ranking PNCP - Vis√£o por Fornecedor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { border-top-color: #3b82f6; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .detalhes-row { display: none; background-color: #f8fafc; }
        .detalhes-row.active { display: table-row; }
        .scroll-custom::-webkit-scrollbar { width: 6px; }
        .scroll-custom::-webkit-scrollbar-track { background: #f1f5f9; }
        .scroll-custom::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 p-4 font-sans antialiased text-slate-800">

    <div class="max-w-7xl mx-auto">
        <header class="bg-white p-6 rounded-2xl shadow-sm mb-6 flex justify-between items-center border border-slate-200">
            <div>
                <h1 class="text-2xl font-black text-slate-900 tracking-tight italic">üìä PNCP <span class="text-blue-600">RANKING</span></h1>
                <div id="status" class="mt-2 text-[10px] font-bold px-3 py-1 rounded-full bg-blue-50 text-blue-600 border border-blue-100 uppercase inline-block">Conectando...</div>
            </div>
            <div class="text-right">
                <p class="text-[10px] uppercase font-bold text-slate-400 tracking-widest">Base de Dados</p>
                <div id="count" class="text-xl font-black text-slate-700">0 Processos</div>
            </div>
        </header>

        <div class="bg-white p-6 rounded-2xl shadow-sm mb-6 border border-slate-200">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                    <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Edital</label>
                    <input type="text" id="fEdital" placeholder="000/2024" class="w-full p-2 border rounded-lg text-xs outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">UASG</label>
                    <input type="text" id="fUasg" placeholder="C√≥digo" class="w-full p-2 border rounded-lg text-xs outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Fornecedor</label>
                    <input type="text" id="fFornecedor" placeholder="Nome ou CNPJ" class="w-full p-2 border rounded-lg text-xs outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Cidade</label>
                    <input type="text" id="fCidade" placeholder="Busca" class="w-full p-2 border rounded-lg text-xs outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Estado</label>
                    <input type="text" id="fUf" maxlength="2" placeholder="UF" class="w-full p-2 border rounded-lg text-xs outline-none focus:ring-2 focus:ring-blue-500 uppercase">
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-slate-200">
            <table class="min-w-full">
                <thead class="bg-slate-900 text-white text-[10px] uppercase font-bold tracking-widest">
                    <tr>
                        <th class="px-6 py-4 text-left">Edital / UASG</th>
                        <th class="px-6 py-4 text-left">√ìrg√£o / Localidade</th>
                        <th class="px-6 py-4 text-right">Valor Total</th>
                    </tr>
                </thead>
                <tbody id="corpo" class="text-sm divide-y divide-slate-100"></tbody>
            </table>
        </div>

        <div class="mt-6 flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-200">
            <button id="btnPrev" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg text-xs font-bold disabled:opacity-30">Anterior</button>
            <div class="text-center">
                <span id="pageInfo" class="text-xs font-bold text-slate-500 uppercase tracking-widest">P√°gina 1</span>
                <div id="totalVolume" class="text-[10px] text-emerald-600 font-black mt-1 uppercase">R$ 0,00 Filtrado</div>
            </div>
            <button id="btnNext" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg text-xs font-bold disabled:opacity-30">Pr√≥xima</button>
        </div>
    </div>

    <div id="spinner" class="fixed inset-0 bg-white/95 flex flex-col items-center justify-center z-50">
        <div class="loading w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full mb-4"></div>
        <p id="spinnerText" class="text-slate-500 font-bold text-xs uppercase tracking-widest text-center px-4">Conectando...</p>
        <div id="progressBytes" class="mt-2 text-[10px] font-mono text-blue-500">0 MB / 0 MB</div>
    </div>

    <script>
        let fullData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 25;

        async function init() {
            const statusEl = document.getElementById('status');
            const spinnerEl = document.getElementById('spinner');
            const spinnerText = document.getElementById('spinnerText');
            const progressBytes = document.getElementById('progressBytes');

            try {
                const response = await fetch('dados_pncp.zip?v=' + Date.now());
                if (!response.ok) throw new Error("Falha ao baixar ZIP.");

                const contentLength = +response.headers.get('Content-Length');
                const reader = response.body.getReader();
                let receivedLength = 0;
                let chunks = [];

                while(true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    receivedLength += value.length;
                    spinnerText.innerText = "Baixando base de dados...";
                    progressBytes.innerText = `${(receivedLength / 1024 / 1024).toFixed(2)} MB / ${(contentLength / 1024 / 1024).toFixed(2)} MB`;
                }

                spinnerText.innerText = "Descompactando e Agrupando...";
                let allChunks = new Uint8Array(receivedLength);
                let pos = 0;
                for(let c of chunks) { allChunks.set(c, pos); pos += c.length; }

                const zip = await JSZip.loadAsync(allChunks);
                const jsonFile = Object.values(zip.files).find(f => f.name.toLowerCase().endsWith('.json') && !f.dir);
                const text = await jsonFile.async("string");
                
                fullData = JSON.parse(text);
                filteredData = [...fullData];

                spinnerEl.classList.add('hidden');
                statusEl.innerText = "SISTEMA ONLINE";
                statusEl.className = "mt-2 text-[10px] font-bold px-3 py-1 rounded-full bg-green-50 text-green-600 border border-green-100 uppercase inline-block";
                
                document.getElementById('count').innerText = fullData.length + " Processos";
                applyFilters();

            } catch (e) {
                spinnerEl.innerHTML = `<div class="p-8 text-center text-red-500 font-bold">${e.message}</div>`;
            }
        }

        function applyFilters() {
            const f = {
                edital: document.getElementById('fEdital').value.toLowerCase(),
                uasg: document.getElementById('fUasg').value.toLowerCase(),
                forn: document.getElementById('fFornecedor').value.toLowerCase(),
                cid: document.getElementById('fCidade').value.toLowerCase(),
                uf: document.getElementById('fUf').value.toLowerCase()
            };

            filteredData = fullData.filter(d => {
                const matchForn = !f.forn || Object.keys(d.resumo || {}).some(n => n.toLowerCase().includes(f.forn));
                return (
                    (d.edital || "").toLowerCase().includes(f.edital) &&
                    (d.uasg || "").toLowerCase().includes(f.uasg) &&
                    (d.cidade || "").toLowerCase().includes(f.cid) &&
                    (d.uf || "").toLowerCase().includes(f.uf) &&
                    matchForn
                );
            });

            currentPage = 1;
            const totalVal = filteredData.reduce((acc, curr) => acc + (curr.total_licitacao || 0), 0);
            document.getElementById('totalVolume').innerText = totalVal.toLocaleString('pt-br', {style:'currency', currency:'BRL'}) + " Filtrado";
            renderPage();
        }

        function renderPage() {
            const corpo = document.getElementById('corpo');
            const start = (currentPage - 1) * itemsPerPage;
            const pageData = filteredData.slice(start, start + itemsPerPage);

            let html = "";
            pageData.forEach((lic, i) => {
                const idx = start + i;
                
                // AGRUPAMENTO POR FORNECEDOR
                const grupos = (lic.itens || []).reduce((acc, it) => {
                    const f = it.fornecedor || "Desconhecido";
                    if (!acc[f]) acc[f] = { items: [], total: 0, cnpj: it.cnpj };
                    acc[f].items.push(it);
                    acc[f].total += (it.total || 0);
                    return acc;
                }, {});

                const gruposHtml = Object.entries(grupos).sort((a,b) => b[1].total - a[1].total).map(([nome, info]) => `
                    <div class="mb-6 bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm">
                        <div class="bg-slate-50 px-4 py-2 flex justify-between items-center border-b border-slate-200">
                            <span class="text-[10px] font-black text-slate-700 uppercase tracking-tight">
                                ${nome} <span class="font-normal text-slate-400 ml-1">(${info.cnpj || '---'})</span>
                            </span>
                            <span class="text-[10px] font-black text-blue-600 bg-white px-2 py-1 rounded border border-blue-100 shadow-sm">
                                GANHOU NESTE EDITAL: R$ ${info.total.toLocaleString('pt-br', {minimumFractionDigits: 2})}
                            </span>
                        </div>
                        <div class="overflow-x-auto scroll-custom">
                            <table class="w-full text-[10px] text-left">
                                <thead class="bg-slate-50/50 text-slate-400 border-b">
                                    <tr>
                                        <th class="p-2 w-12 text-center">ITEM</th>
                                        <th class="p-2">DESCRI√á√ÉO</th>
                                        <th class="p-2 text-center">QTD</th>
                                        <th class="p-2 text-right">UNIT√ÅRIO</th>
                                        <th class="p-2 text-right">TOTAL</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${info.items.map(it => `
                                        <tr class="hover:bg-slate-50 transition-colors">
                                            <td class="p-2 text-center font-bold text-slate-300">#${it.item}</td>
                                            <td class="p-2 text-slate-600 leading-tight">${it.desc}</td>
                                            <td class="p-2 text-center font-bold text-slate-700">${it.qtd}</td>
                                            <td class="p-2 text-right text-slate-400 font-mono">R$ ${it.unitario.toLocaleString('pt-br', {minimumFractionDigits: 2})}</td>
                                            <td class="p-2 text-right font-black text-slate-800 font-mono">R$ ${it.total.toLocaleString('pt-br', {minimumFractionDigits: 2})}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `).join('');

                html += `
                    <tr class="cursor-pointer hover:bg-blue-50/50 transition-colors" onclick="document.getElementById('d-${idx}').classList.toggle('active')">
                        <td class="px-6 py-5">
                            <div class="font-black text-blue-600 text-sm tracking-tight">${lic.edital || 'S/N'}</div>
                            <div class="text-[9px] font-mono text-slate-400 bg-slate-100 px-1 rounded inline-block">UASG: ${lic.uasg || '---'}</div>
                        </td>
                        <td class="px-6 py-5">
                            <div class="font-bold text-slate-700 text-xs uppercase truncate w-64">${lic.orgao || 'N/A'}</div>
                            <div class="text-[9px] text-slate-400 font-bold uppercase tracking-tighter">${lic.cidade || ''} / ${lic.uf || ''}</div>
                        </td>
                        <td class="px-6 py-5 text-right font-black text-slate-900 text-sm">R$ ${(lic.total_licitacao || 0).toLocaleString('pt-br', {minimumFractionDigits: 2})}</td>
                    </tr>
                    <tr id="d-${idx}" class="detalhes-row">
                        <td colspan="3" class="p-6 bg-slate-100/30">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2">
                                    <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span> Itens Agrupados por Empresa
                                </h4>
                                <a href="${lic.link_edital}" target="_blank" class="text-[10px] bg-slate-900 text-white px-3 py-1.5 rounded-lg font-bold uppercase hover:bg-slate-700 transition shadow-md">Acessar PNCP Oficial ‚Üó</a>
                            </div>
                            <div class="max-h-[600px] overflow-y-auto pr-2 scroll-custom">
                                ${gruposHtml}
                            </div>
                        </td>
                    </tr>`;
            });

            corpo.innerHTML = html || '<tr><td colspan="3" class="p-10 text-center text-slate-400 italic font-medium">Nenhum edital encontrado com esses filtros.</td></tr>';
            
            const totalPages = Math.ceil(filteredData.length / itemsPerPage) || 1;
            document.getElementById('pageInfo').innerText = `P√°gina ${currentPage} de ${totalPages}`;
            document.getElementById('btnPrev').disabled = currentPage === 1;
            document.getElementById('btnNext').disabled = currentPage === totalPages || filteredData.length === 0;
        }

        ['fEdital', 'fUasg', 'fFornecedor', 'fCidade', 'fUf'].forEach(id => {
            document.getElementById(id).addEventListener('input', applyFilters);
        });

        document.getElementById('btnPrev').onclick = () => { if(currentPage > 1) { currentPage--; renderPage(); window.scrollTo({top: 0, behavior: 'smooth'}); } };
        document.getElementById('btnNext').onclick = () => { if(currentPage < Math.ceil(filteredData.length / itemsPerPage)) { currentPage++; renderPage(); window.scrollTo({top: 0, behavior: 'smooth'}); } };

        init();
    </script>
</body>
</html>
